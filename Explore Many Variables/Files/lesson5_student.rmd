Lesson 5
========================================================

### Multivariate Data
Notes: In this lesson, we'll learn how to examine 3 or more variables at a time.

```{r Multivariate Data}
getwd()
setwd("/Users/Sim/Desktop/Nanodegrees/Data Analyst/Task 4/Data Analysis with R/Explore Many Variables/Files/")
list.files()
```


***

### Moira Perceived Audience Size Colored by Age
Notes: Moira's next question was although in general people weren't good at guessing their audience size, maybe certain groups be better e.g. older people would be better than teens.

So next step was to do another scatter plot with a third level, where color was added to represent the age of the survey respondent - although this wasn't that useful.

[Moira's Investigation from Lesson 3](https://classroom.udacity.com/courses/ud651/lessons/755618712/concepts/8140986010923)

[Bernstein, M. S., Bakshy, E., Burke, M., & Karrer, B. (2013). Quantifying the invisible audience in social networks. In Proceedings of the SIGCHI Conference on Human Factors in Computing Systems (CHI 2013), pp. 21-30.](http://hci.stanford.edu/publications/2013/invisibleaudience/invisibleaudience.pdf) 

***

### Third Qualitative Variable
Notes: Sometimes when we conduct EDA, we reach dead ends.

Let's try to get further into the friend_count data from before. Recall, female users had more friends on average than male users.**Is this just because females have a different age distribution?**

From the boxplot we can see the average age of males is slightly younger. From the lineplot, we can see the median for women is almost higher everywhere than it is for men.

You can include multiple variables to split the data frame when using **group_by()** function in the dplyr package. 

```{r}
new_groupings <- group_by(data, variable1, variable2) 
# OR 
# using chained commands... 
new_data_frame <- data_frame %.% 
  group_by(variable1, variable2) %.% 
```

[Repeated use of summarise() and group_by()](http://stackoverflow.com/questions/21653295/dplyr-issues-when-using-group-bymultiple-variables): The summarize function will automatically remove one level of grouping (the last group it collapsed).

```{r Third Qualitative Variable}
library(dplyr)
library(ggplot2)
pf <- read.csv('pseudo_facebook.tsv', sep='\t')

# Creating the boxplot, and adding the mean 
ggplot(aes(x = gender, y = age),
       data = subset(pf, !is.na(gender))) + 
  geom_boxplot() +
  stat_summary(fun.y = mean, geom = 'point', shape = 4)

# Lineplot for age and friend_count
ggplot(aes(x = age, y = friend_count),
       data = subset(pf, !is.na(gender))) + 
  geom_line(aes(color=gender), stat='summary', fun.y = median)
```

#### Write code to create a new data frame, called 'pf.fc_by_age_gender', that contains information on each age AND gender group.

```{r Third Qualitative Variable Quiz}
# Chain functions together %>%
pf.fc_by_age_gender <- pf %>%
  filter(!is.na(gender)) %>%
  group_by(age, gender) %>%
  summarise(mean_friend_count = mean(friend_count),
            median_friend_count = median(friend_count),
            n = n()) %>%
  ungroup() %>%
  arrange(age)

head(pf.fc_by_age_gender)

```

***

### Plotting Conditional Summaries
Notes: Plot the median friend count for each gender as age increases.

Create a line graph showing the median friend count over the ages for each gender. Be sure to use the data frame you just created, **pf.fc_by_age_gender**.

```{r Plotting Conditional Summaries}
ggplot(aes(age, median_friend_count), 
       data = pf.fc_by_age_gender) +
  geom_line(aes(color = gender))
```

***

### Thinking in Ratios
Notes: The plot above could be useful if we want to inspect these values, or carry out further operations to understand how the difference between male and female users varies with age (e.g. plot above shows gender difference is largest for our young users).

It would be helpful to put this in relevant terms though. So lets answer the question: **how many times more friends does the average female user have than the male user?**

***

### Wide and Long Format
Notes: You can also restructure the data using the **tidyr** package. You can review examples and how to use the package in the [Data Wrangling with R](https://s3.amazonaws.com/udacity-hosted-downloads/ud651/DataWranglingWithR.pdf) pdf.

The code to change the data frame from long format to wide (or tidy format) is shown below. I encourage you to read the Data Wrangling pdf and write code using the tidyr package before looking at the solution below. 

```{r Wide and Long Format}
#install.packages("tidyr") # only need to run this once 
library(tidyr)
spread(subset(pf.fc_by_age_gender,
              select = c('gender', 'age', 'median_friend_count')),
       gender,
       median_friend_count)
```

The **tidyr** package is easier to use than the **reshape2** package. Both packages can get the job done.

[An Introduction to reshape2](http://seananderson.ca/2013/10/19/reshape.html) by Sean Anderson

[Converting Between Long and Wide Format](http://www.cookbook-r.com/Manipulating_data/Converting_data_between_wide_and_long_format/)

[Melt Data Frames](https://www.r-bloggers.com/melt/)

***

### Reshaping Data
Notes: 

**Letter d is used in dcast() since we wanted the result to be dataframe. If we wanted an array or matrix, we would use acast/mcast respectively.**

```{r}
#install.packages('reshape2')
library(reshape2)

# Letter d is used since we wanted the result to be dataframe. We specify dataframe we wanted to change and then a formula.
pf.fc_by_age_gender.wide <- dcast(pf.fc_by_age_gender,
                                  age ~ gender,
                                  value.var = "median_friend_count")

head(pf.fc_by_age_gender.wide)

# We could also create a similar data frame using the dplyr and tidyr packages: 
pf.fc_by_age_gender.wide <- subset(pf.fc_by_age_gender[c('age', 'gender', 'median_friend_count')],
                                   !is.na(gender)) %>% 
  spread(gender, median_friend_count) %>% 
  mutate(ratio = male / female) 

head(pf.fc_by_age_gender.wide)

```


***

### Ratio Plot

#### Plot the ratio of the female to male median friend counts using the data frame **pf.fc_by_age_gender.wide.**

Think about what geom you should use. 

Add a horizontal line to the plot with a y intercept of 1, which will be the base line. Look up the documentation for **geom_hline** to do that. Use the parameter linetype in **geom_hline** to make the line dashed.

The linetype parameter can take the values 0-6:
0 = blank, 1 = solid, 2 = dashed, 3 = dotted, 4 = dotdash, 5 = longdash, 6 = twodash

```{r Ratio Plot}
ggplot(aes(x = age, y = female/male), 
       data = pf.fc_by_age_gender.wide) +
  geom_line() +
  geom_hline(yintercept = 1, alpha = 0.3,  linetype = 2)
  
```

From the plot, we can see that for young users, the median female user has over 2 times as many friends as the male user. 

***

### Third Quantitative Variable
Notes: **Usually, color or shape tend to be aesthetics for representing changes over a categorial variable.**

#### Assignment
Create a variable called year_joined in the pf data frame using the variable tenure and 2014 as the reference year. The variable year joined should contain the year that a user joined facebook.

**Hint 1**: Divide the tenure variable by a number. Tenure is measured in days, but we want to convert it to years. 

**Hint 2**: Subtract tenure measured in years from 2014. What does the decimal portion represent? Should we round up or round down to the closest year? 

```{r Third Quantitative Variable}
names(pf)

# Hold the year, user's first joined facebook. Floor returns the greatest int not larger than that number in brackets (i.e. round's down)
pf$year_joined <- floor(2014 - pf$tenure/365)
  
```

***

### Cut a Variable
Notes: **The cut function is useful for making discrete variables from continuous or numerical ones, sometimes in combination with the function quantile.**

[The Cut Function](https://www.r-bloggers.com/r-function-of-the-day-cut-2/)

Be sure to close your parentheses!

A common mistake is to use **year_joined** rather than **pf$year_joined** or **with(pf, year_joined...)**. Remember that you need to access the variable in the data frame.

#### Assignment
Create a new variable in the data frame called **year_joined.bucket** by using the cut function on the variable **year_joined**.

```{r Cut a Variable}
summary(pf$year_joined)

table(pf$year_joined)

pf$year_joined.bucket <- cut(pf$year_joined, 
                             breaks = c(2004, 2009, 2011, 2012, 2014))
table(pf$year_joined.bucket)

```

***

### Plotting it All Together

Create a line graph of **friend_count vs. age** so that each **year_joined.bucket** is a line tracking the median user **friend_count** across **age**. This means you should have four different lines on your plot.

You should subset the data to exclude the users whose **year_joined.bucket** is NA.

```{r Plotting it All Together}
table(pf$year_joined.bucket, useNA = 'ifany')

ggplot(aes(x = age, y = friend_count), 
       data = subset(pf, !is.na(year_joined.bucket))) + 
  geom_line(aes(color = year_joined.bucket), stat = 'summary', fun.y = median)
```

***

### Plot the Grand Mean
Notes: Looking at the previous plot, we can confirm our suspicions that user's with longer tenure tend to have a higher friend count, with the exception of older users.

#### Assignment 
Write code to do the following:

* Add another geom_line to code below to plot the grand mean of the friend count vs age.
* Exclude any users whose year_joined.bucket is NA.
* Use a different line type for the grand mean.

```{r Plot the Grand Mean}
ggplot(aes(x = age, y = friend_count), 
       data = subset(pf, !is.na(year_joined.bucket))) + 
  geom_line(aes(color = year_joined.bucket), stat = 'summary', fun.y = mean) +
  geom_line(stat = 'summary', fun.y = mean, linetype = 2)

```

Plotting the grand mean (the second geom_line in the code) is a good reminder that much of the data in the sample is about members of recent cohorts. This is the type of more high level observation that you want to make as you explore data.

***

### Friending Rate
Notes:

```{r Friending Rate}

```

***

### Friendships Initiated
Notes:

What is the median friend rate?

What is the maximum friend rate?

```{r Friendships Initiated}

```

***

### Bias-Variance Tradeoff Revisited
Notes:

```{r Bias-Variance Tradeoff Revisited}

ggplot(aes(x = tenure, y = friendships_initiated / tenure),
       data = subset(pf, tenure >= 1)) +
  geom_line(aes(color = year_joined.bucket),
            stat = 'summary',
            fun.y = mean)

ggplot(aes(x = 7 * round(tenure / 7), y = friendships_initiated / tenure),
       data = subset(pf, tenure > 0)) +
  geom_line(aes(color = year_joined.bucket),
            stat = "summary",
            fun.y = mean)

ggplot(aes(x = 30 * round(tenure / 30), y = friendships_initiated / tenure),
       data = subset(pf, tenure > 0)) +
  geom_line(aes(color = year_joined.bucket),
            stat = "summary",
            fun.y = mean)

ggplot(aes(x = 90 * round(tenure / 90), y = friendships_initiated / tenure),
       data = subset(pf, tenure > 0)) +
  geom_line(aes(color = year_joined.bucket),
            stat = "summary",
            fun.y = mean)

```

***

### Sean's NFL Fan Sentiment Study
Notes:

***

### Introducing the Yogurt Data Set
Notes:

***

### Histograms Revisited
Notes:

```{r Histograms Revisited}

```

***

### Number of Purchases
Notes:

```{r Number of Purchases}

```

***

### Prices over Time
Notes:

```{r Prices over Time}

```

***

### Sampling Observations
Notes:

***

### Looking at Samples of Households

```{r Looking at Sample of Households}

```

***

### The Limits of Cross Sectional Data
Notes:

***

### Many Variables
Notes:

***

### Scatterplot Matrix
Notes:

***

### Even More Variables
Notes:

***

### Heat Maps
Notes:

```{r}
nci <- read.table("nci.tsv")
colnames(nci) <- c(1:64)
```

```{r}
nci.long.samp <- melt(as.matrix(nci[1:200,]))
names(nci.long.samp) <- c("gene", "case", "value")
head(nci.long.samp)

ggplot(aes(y = gene, x = case, fill = value),
  data = nci.long.samp) +
  geom_tile() +
  scale_fill_gradientn(colours = colorRampPalette(c("blue", "red"))(100))
```


***

### Analyzing Three of More Variables
Reflection:

***

Click **KnitHTML** to see all of your hard work and to have an html
page of this lesson, your answers, and your notes!

